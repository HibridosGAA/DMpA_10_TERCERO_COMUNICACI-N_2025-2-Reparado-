<!-- topics.html: Lista de temas de debate con inicialización de Firebase -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecretPass | Temas de Debate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // --- INICIALIZACIÓN Y CONFIGURACIÓN DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Variables inyectadas por Flask
        const __app_id = "{{ app_id }}";
        const __firebase_config = "{{ firebase_config_json | safe }}";

        // Necesitas asegurarte de que la clave de la sala está aquí
        const roomKey = new URLSearchParams(window.location.search).get('room');
        
        let db, auth;
        let userId = null; 
        
        // Función para mostrar errores de forma visible
        const displayError = (message) => {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = `Error: ${message}`;
            errorElement.classList.remove('hidden');
        };

        // Función para la inicialización y autenticación
        const initFirebase = async () => {
            try {
                // 1. Configuración de Firebase
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 2. Autenticación Anónima
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;
                
                console.log("Firebase inicializado y autenticado. User ID:", userId);

                // 3. Iniciar la carga de temas
                loadTopics();

            } catch (error) {
                console.error("Error al inicializar o autenticar Firebase:", error);
                displayError("Error al inicializar Firebase. Revisa la consola o las variables de Render.");
            }
        };

        // Función para cargar los temas desde Firestore
        const loadTopics = () => {
            const topicsList = document.getElementById('topics-list');
            
            // La ruta de la colección se basa en la clave de la sala (roomKey)
            const topicsCollectionRef = collection(db, `artifacts/${__app_id}/public/data/topics_${roomKey}`);
            const topicsQuery = query(topicsCollectionRef);

            // Escuchar cambios en tiempo real
            onSnapshot(topicsQuery, (snapshot) => {
                topicsList.innerHTML = '';
                if (snapshot.empty) {
                    topicsList.innerHTML = '<p class="text-center text-gray-500 mt-4">No hay temas. ¡Sé el primero en crear uno!</p>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const topicCard = document.createElement('a');
                    
                    // Enlace que lleva a la sala de chat específica para este tema
                    topicCard.href = `/room?room=${roomKey}&topic=${doc.id}`; 
                    topicCard.className = "block bg-white border border-gray-200 rounded-xl p-5 shadow-lg hover:shadow-xl hover:bg-gray-50 transition duration-200 cursor-pointer";
                    topicCard.innerHTML = `
                        <h2 class="text-xl font-semibold text-gray-800">{{ data.title }}</h2>
                        <p class="text-sm text-gray-600 mt-1">Creado por: ${data.creatorId.substring(0, 8)}... | ${new Date(data.timestamp?.toMillis()).toLocaleString()}</p>
                    `;
                    topicsList.appendChild(topicCard);
                });
            }, (error) => {
                console.error("Error al escuchar temas:", error);
                displayError("Error al cargar los temas.");
            });
        };

        // Función para crear un nuevo tema
        window.createTopic = async () => {
            const topicInput = document.getElementById('topic-title-input');
            const title = topicInput.value.trim();

            if (!title) {
                alert("Por favor, introduce un título para el tema.");
                return;
            }
            
            if (!db || !userId) {
                displayError("El sistema no está inicializado. Recarga la página.");
                return;
            }

            try {
                // La colección de temas es pública para el grupo
                await addDoc(collection(db, `artifacts/${__app_id}/public/data/topics_${roomKey}`), {
                    title: title,
                    creatorId: userId,
                    timestamp: serverTimestamp()
                });
                topicInput.value = '';
            } catch (error) {
                console.error("Error al crear el tema:", error);
                displayError("Fallo al crear el tema. Revisa permisos.");
            }
        };

        // Iniciar Firebase cuando la página cargue
        window.onload = initFirebase;
        
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f9; /* Fondo claro */
        }
        /* Estilo para que el contenedor del tema se vea bien */
        #topics-list > a {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-100">

        <header class="flex justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-indigo-600">SecretPass</h1>
            <a href="/logout" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">Salir</a>
        </header>

        <h2 class="text-xl font-semibold text-gray-800 mb-4">Selecciona o crea un nuevo tema de debate.</h2>
        <p class="text-sm text-gray-500 mb-6">Acceso: <span class="font-mono text-indigo-500">{{ session['room_key'] }}</span></p>


        <!-- Formulario para Crear Nuevo Tema -->
        <div class="flex flex-col sm:flex-row gap-3 mb-8 p-4 bg-indigo-50 rounded-xl border border-indigo-200 shadow-inner">
            <input 
                type="text" 
                id="topic-title-input" 
                placeholder="Escribe un título para un nuevo tema (ej: Futuro de la IA)"
                class="flex-grow px-4 py-3 border border-indigo-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-800"
            >
            <button
                onclick="createTopic()"
                class="shrink-0 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition duration-200 shadow-lg"
            >
                Crear Tema
            </button>
        </div>
        
        <!-- Contenedor de la lista de temas -->
        <div id="topics-list" class="space-y-4">
            <p class="text-center text-gray-500 mt-4">Cargando temas...</p>
        </div>

        <!-- Mensaje de error para Firebase -->
        <p id="error-message" class="text-center text-red-600 mt-6 hidden font-semibold"></p>
    </div>
</body>
</html>
